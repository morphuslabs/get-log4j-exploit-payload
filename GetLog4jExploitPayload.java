import javax.naming.InitialContext;
import java.io.FileOutputStream;
import javax.naming.Reference;
import java.io.BufferedInputStream;
import java.io.IOException;
import java.net.URL;
import java.io.File;

public class GetLog4jExploitPayload {

public static void main(String[] args) throws Exception
{

        if (args.length < 2)
        {
            System.out.println("Error: please, provide the ldap/rmi address and the output-dir parameters.");
            System.out.println("Eg: java GetLog4jExploitPayload ldap://127.0.0.1:1389/a payloads");
            System.exit(1);
        }

        InitialContext ctx = new InitialContext();
        Reference res = (Reference)ctx.lookup(args[0]);

        String payloadAddress = res.getFactoryClassLocation() + res.getFactoryClassName() + ".class";
        System.out.println("Referenced class: " + payloadAddress);

        System.out.print("Retrieving payload...");

        try (BufferedInputStream in = new BufferedInputStream(new URL(payloadAddress).openStream());
            FileOutputStream fileOutputStream = new FileOutputStream(args[1] + File.separator + res.getFactoryClassName()+".class.dump")) 
            {
                byte dataBuffer[] = new byte[1024];
                int bytesRead;
                while ((bytesRead = in.read(dataBuffer, 0, 1024)) != -1) 
                {
                        fileOutputStream.write(dataBuffer, 0, bytesRead);
                }
        } catch (IOException e) 
        {
            // handle exception
        }

        System.out.println("done.");

    }

}
